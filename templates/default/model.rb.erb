# encoding: utf-8

<%
  app = @app
  name = @name
  description = @description
  storages = @storages
  databases = @databases
  sync_config = @sync_config
  enc_config = @enc_config
  mail_config = @mail_config
%>

Model.new(:<%= name %>, "<%= description %>") do
  archive :application do |archive|
    <% if app["backup"]["archive"]["use_sudo"] %>
    archive.use_sudo
    <% end %>
    <% if app["backup"]["archive"]["root"] %>
    archive.root "/opt/applications"
    <% end %>
    <% app["backup"]["archive"]["add"].each do |path| %>
    archive.add "<%= path %>"
    <% end %>
  end

  <% (storages || []).each do |storage| %>
    <% (storage["s3"] || []).each do |s| %>
  store_with S3 do |s3|
    s3.access_key_id     = "<%= s["access_key_id"] %>"
    s3.secret_access_key = "<%= s["secret_access_key"] %>"
    s3.region            = "<%= s["region"] %>"
    s3.bucket            = "<%= s["bucket"] %>"
    s3.path              = "<%= s["path"] %>"
    s3.keep              = "<%= s["keep"] %>"
  end
    <% end %>
    <% (storage["sftp"] || []).each do |s| %>
  store_with SFTP do |server|
    server.username = "<%= s["username"] %>"
    server.password = "<%= s["password"] %>"
    server.ip       = "<%= s["host"] %>"
    server.port     = <%= s["port"] || 22 %>
    server.path     = "<%= s["path"] %>"
    server.keep     = "<%= s["keep"] %>"
  end
    <% end %>
  <% end %>

  <% (databases || []).each do |ddbb| %>
    <% (ddbb["mysql"] || []).each do |d| %>
  database MySQL do |db|
    db.name               = "<%= d["name"] %>"
    db.username           = "<%= d["username"] %>"
    db.password           = "<%= d["password"] %>"
    <% if d["socket"] %>
    db.socket             = "<%= d["socket"] %>"
    <% else %>
    db.host               = "<%= d["host"] || "localhost" %>"
    db.port               = <%= d["port"] || 3306 %>
    <% end %>
    db.prepare_backup     = <%= d["prepare_backup"] || true %>
  end
    <% end %>
  <% end %>

  <% if app["backup"]["compress"] %>
  compress_with Gzip
  <% end %>

  <% (sync_config || []).each do |sc| %>
    <% (sc["rsync"] || []).each do |r| %>
  sync_with RSync::Push do |rsync|
    rsync.mode                        = :<%= r["mode"] || "rsync_daemon" %>
    rsync.host                        = "<%= r["host"] %>"
    <% if r["rsync_user"] %>
    rsync.rsync_user                  = "<%= r["rsync_user"] %>"
    <% end %>
    <% if r["rsync_password"] %>
    rsync.rsync_password              = "<%= r["rsync_password"] %>"
    <% end %>
    rsync.port                        = "<%= r["port"] || "873" %>"
    <% if r["ssh_user"] %>
    rsync.ssh_user                    = "<%= r["ssh_user"] %>"
    <% end %>
    <% if r["additional_ssh_options"] %>
    rsync.additional_ssh_options      = "<%= r["additional_ssh_options"] %>"
    <% end %>
    <% if r["additional_rsync_options"] %>
    rsync.additional_rsync_options    = "<%= r["additional_rsync_options"] %>"
    <% end %>
    rsync.mirror                      = <%= r["mirror"] || true %>
    rsync.compress                    = <%= r["compress"] || true %>

    rsync.directories do |directory|
      <% r["directory"]["add"].each do |dir| %>
      directory.add "<%= "#{dir}" %>"
      <% end %>
      <% r["directory"]["exclude"].each do |dir| %>
      directory.exclude "<%= "#{dir}" %>"
      <% end %>
    end
    rsync.path = "<%= r["path"] || "backups" %>"
  end
    <% end %>
  <% end %>

  <% if enc_config %>
    <% if enc_config["type"] == "openssl" %>
  encrypt_with OpenSSL do |encryption|
    encryption.password = "<%= enc_config["password"] %>"
    encryption.base64   = <%= enc_config["base64"] || true %>
    encryption.salt     = <%= enc_config["salt"] || true %>
  end
    <% end %>
  <% end %>

  <% if mail_config %>
  notify_by Mail do |mail|
    mail.on_success           = <%= mail_config["on_success"] || "true" %>
    mail.on_warning           = <%= mail_config["on_warning"] || "true" %>
    mail.on_failure           = <%= mail_config["on_failure"] || "true" %>
    mail.from                 = "<%= mail_config["from"] %>"
    mail.to                   = "<%= mail_config["to"] %>"
    mail.address              = "<%= mail_config["address"] %>"
    mail.port                 = <%= mail_config["port"] || "587" %>
    mail.domain               = "<%= mail_config["domain"] %>"
    mail.user_name            = "<%= mail_config["user_name"] %>"
    mail.password             = "<%= mail_config["password"] %>"
    mail.authentication       = "<%= mail_config["authentication"] || "login"%>"
    mail.encryption           = :<%= mail_config["encryption"] || "starttls" %>
  end
  <% end %>
end
